<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherNext Lab - AI Cyclone Prediction</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåÄ</text></svg>">

    <!-- TensorFlow.js with WASM backend -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@4.17.0/dist/tf-backend-wasm.js"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Dark theme (default) */
            --bg-primary: #0a0a1a;
            --bg-secondary: #12122a;
            --bg-card: rgba(255,255,255,0.05);
            --bg-card-hover: rgba(255,255,255,0.08);
            --border: rgba(255,255,255,0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.7);
            --text-muted: rgba(255,255,255,0.5);
            --accent: #4285f4;
            --success: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --globe-bg: #050510;
            --ocean: #0a1628;
            --land: rgba(40, 80, 60, 0.9);
        }

        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-card: rgba(0,0,0,0.03);
            --bg-card-hover: rgba(0,0,0,0.06);
            --border: rgba(0,0,0,0.1);
            --text-primary: #1a1a2e;
            --text-secondary: rgba(0,0,0,0.7);
            --text-muted: rgba(0,0,0,0.5);
            --globe-bg: #e8f4fc;
            --ocean: #a8d5e5;
            --land: rgba(80, 140, 100, 0.9);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        /* Loading */
        #loading {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        #loading.hidden { opacity: 0; pointer-events: none; }
        .spinner {
            width: 60px; height: 60px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: var(--text-secondary); }
        .progress-bar {
            width: 200px; height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            width: 0%;
            transition: width 0.3s;
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 600;
        }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--accent), #9c27b0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }
        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .theme-toggle {
            width: 44px; height: 44px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        .theme-toggle:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background: var(--bg-card-hover); border-color: var(--accent); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-primary:hover { background: #3367d6; }

        /* Main Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1.5rem;
        }
        @media (max-width: 1200px) {
            .dashboard { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .card:hover { border-color: var(--accent); }
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body { padding: 1.5rem; }

        /* Globe */
        .globe-card {
            position: relative;
            aspect-ratio: 16/10;
            min-height: 500px;
        }
        #globe-container {
            position: absolute;
            inset: 0;
            background: var(--globe-bg);
            border-radius: 16px;
        }

        /* Globe Controls */
        .globe-overlay {
            position: absolute;
            inset: 1rem;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .globe-overlay > * { pointer-events: auto; }
        .globe-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .model-tabs {
            display: flex;
            gap: 4px;
            background: rgba(0,0,0,0.6);
            padding: 4px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        [data-theme="light"] .model-tabs { background: rgba(255,255,255,0.9); }
        .model-tab {
            padding: 8px 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        .model-tab.active { background: var(--accent); color: white; }
        .model-tab:hover:not(.active) { background: rgba(255,255,255,0.1); }
        [data-theme="light"] .model-tab:hover:not(.active) { background: rgba(0,0,0,0.1); }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.6);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }
        [data-theme="light"] .live-badge { background: rgba(255,255,255,0.9); color: var(--text-primary); }
        .live-dot {
            width: 8px; height: 8px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* Timeline */
        .timeline-panel {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
        }
        [data-theme="light"] .timeline-panel { background: rgba(255,255,255,0.95); }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .timeline-date { font-size: 1rem; font-weight: 500; }
        .timeline-btns { display: flex; gap: 6px; }
        .timeline-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .timeline-btn:hover, .timeline-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .timeline-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 4px;
            outline: none;
        }
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px; height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .timeline-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Legend */
        .legend {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.75rem;
        }
        [data-theme="light"] .legend { background: rgba(255,255,255,0.9); }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-line { width: 20px; height: 3px; border-radius: 2px; }

        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 1rem; }

        /* Storm Info */
        .storm-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .storm-icon {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--danger), var(--warning));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
        }
        .storm-name { font-size: 1.3rem; font-weight: 600; }
        .storm-cat {
            display: inline-block;
            padding: 3px 8px;
            background: var(--danger);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            margin-top: 4px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .stat-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem;
            text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent); }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }

        /* Storm List */
        .storm-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .storm-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .storm-item:hover, .storm-item.active {
            border-color: var(--accent);
            background: var(--bg-card-hover);
        }
        .storm-item-icon { font-size: 1.2rem; }
        .storm-item-info { flex: 1; }
        .storm-item-name { font-weight: 500; font-size: 0.9rem; }
        .storm-item-meta { font-size: 0.7rem; color: var(--text-muted); }

        /* Accuracy Bars */
        .accuracy-item { margin-bottom: 0.75rem; }
        .accuracy-item:last-child { margin-bottom: 0; }
        .accuracy-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .accuracy-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .accuracy-fill { height: 100%; border-radius: 3px; transition: width 1s; }

        /* Chart */
        .chart-card { margin-top: 1.5rem; }
        .chart-container { height: 220px; }

        /* Weather Grid */
        .weather-section { margin-top: 1.5rem; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .section-title { font-size: 1.2rem; font-weight: 600; }
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
        }
        .weather-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s;
        }
        .weather-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .weather-location { font-weight: 600; }
        .weather-country { font-size: 0.75rem; color: var(--text-muted); }
        .weather-icon { font-size: 2.5rem; }
        .weather-temp { font-size: 2rem; font-weight: 300; }
        .weather-details {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Footer */
        footer {
            margin-top: 2rem;
            padding: 2rem;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        footer a { color: var(--accent); text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .globe-card { min-height: 350px; }
            .header-controls .btn span { display: none; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Initializing...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="logo">
            <div class="logo-icon">üåÄ</div>
            <span>WeatherNext Lab</span>
        </div>
        <div class="header-controls">
            <button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>
            <a href="light.html" class="btn" title="Lightweight version">
                <span>Light</span>
            </a>
            <a href="modular.html" class="btn" title="ES6 Modules version">
                <span>Modular</span>
            </a>
            <a href="https://github.com/hwkim3330/WeatherNext" target="_blank" class="btn btn-primary">
                <span>GitHub</span>
            </a>
        </div>
    </header>

    <!-- Main -->
    <main class="container">
        <div class="dashboard">
            <!-- Globe -->
            <div class="card globe-card">
                <div id="globe-container"></div>
                <div class="globe-overlay">
                    <div class="globe-top">
                        <div class="model-tabs">
                            <button class="model-tab active" data-model="ai">AI Ensemble</button>
                            <button class="model-tab" data-model="ecmwf">ECMWF</button>
                            <button class="model-tab" data-model="gfs">GFS</button>
                            <button class="model-tab" data-model="all">Compare</button>
                        </div>
                        <div class="live-badge">
                            <div class="live-dot"></div>
                            <span>LIVE</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-line" style="background:#4285f4"></div>
                                <span>AI Prediction</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background:#34a853"></div>
                                <span>ECMWF</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background:#fbbc04"></div>
                                <span>GFS</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background:#ea4335"></div>
                                <span>Actual Track</span>
                            </div>
                        </div>
                        <div class="timeline-panel" style="flex:1; max-width: 500px; margin-left: 1rem;">
                            <div class="timeline-header">
                                <div class="timeline-date" id="timelineDate">Loading...</div>
                                <div class="timeline-btns">
                                    <button class="timeline-btn" id="btnPrev">‚èÆ</button>
                                    <button class="timeline-btn" id="btnPlay">‚ñ∂</button>
                                    <button class="timeline-btn" id="btnNext">‚è≠</button>
                                </div>
                            </div>
                            <input type="range" class="timeline-slider" id="timelineSlider" min="0" max="100" value="100">
                            <div class="timeline-marks">
                                <span>Start</span>
                                <span>Day 3</span>
                                <span>Day 6</span>
                                <span>Day 9</span>
                                <span>End</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Current Storm -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üåÄ Current Storm</div>
                    </div>
                    <div class="card-body">
                        <div class="storm-header">
                            <div class="storm-icon">üåÄ</div>
                            <div>
                                <div class="storm-name" id="stormName">Loading...</div>
                                <div class="storm-cat" id="stormCat">--</div>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="statWind">--</div>
                                <div class="stat-label">Wind (kt)</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="statPressure">--</div>
                                <div class="stat-label">Pressure (mb)</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="statLat">--</div>
                                <div class="stat-label">Latitude</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="statLon">--</div>
                                <div class="stat-label">Longitude</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Storm List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìã Storms (IBTrACS)</div>
                    </div>
                    <div class="card-body">
                        <div class="storm-list" id="stormList"></div>
                    </div>
                </div>

                <!-- Model Accuracy -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìä Model Accuracy</div>
                    </div>
                    <div class="card-body">
                        <div class="accuracy-item">
                            <div class="accuracy-header">
                                <span>AI Ensemble</span>
                                <span style="color:var(--accent)">96%</span>
                            </div>
                            <div class="accuracy-bar">
                                <div class="accuracy-fill" style="width:96%;background:var(--accent)"></div>
                            </div>
                        </div>
                        <div class="accuracy-item">
                            <div class="accuracy-header">
                                <span>ECMWF ENS</span>
                                <span style="color:var(--success)">89%</span>
                            </div>
                            <div class="accuracy-bar">
                                <div class="accuracy-fill" style="width:89%;background:var(--success)"></div>
                            </div>
                        </div>
                        <div class="accuracy-item">
                            <div class="accuracy-header">
                                <span>GFS</span>
                                <span style="color:var(--warning)">82%</span>
                            </div>
                            <div class="accuracy-bar">
                                <div class="accuracy-fill" style="width:82%;background:var(--warning)"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card chart-card">
            <div class="card-header">
                <div class="card-title">üìà Track Error Comparison</div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="errorChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Weather -->
        <section class="weather-section">
            <div class="section-header">
                <h2 class="section-title">üå§Ô∏è Live Weather (Open-Meteo)</h2>
                <button class="btn" onclick="fetchWeather()">üîÑ Refresh</button>
            </div>
            <div class="weather-grid" id="weatherGrid"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-links">
            <a href="https://deepmind.google/science/weathernext/">DeepMind WeatherNext</a>
            <a href="https://github.com/google-deepmind/graphcast">GraphCast</a>
            <a href="https://www.ncei.noaa.gov/products/international-best-track-archive">NOAA IBTrACS</a>
            <a href="https://open-meteo.com/">Open-Meteo API</a>
        </div>
        <p>Built with TensorFlow.js, Three.js, Chart.js | Inspired by Google DeepMind WeatherNext</p>
    </footer>

    <script>
    // ============================================
    // HURRICANE DATA (NOAA IBTrACS)
    // ============================================
    const STORMS = [
        {
            id: 'beryl2024',
            name: 'Hurricane Beryl',
            cat: 'Category 5',
            dates: 'Jun 28 - Jul 11, 2024',
            basin: 'Atlantic',
            // [lon, lat, wind_kt, pressure_mb, timestamp]
            track: [
                [-45.4, 9.4, 45, 1003, '2024-06-28T12:00Z'],
                [-48.2, 10.1, 60, 996, '2024-06-29T00:00Z'],
                [-51.1, 10.6, 85, 980, '2024-06-29T12:00Z'],
                [-54.0, 10.9, 115, 959, '2024-06-30T00:00Z'],
                [-57.0, 11.1, 130, 946, '2024-06-30T12:00Z'],
                [-59.9, 11.3, 140, 938, '2024-07-01T00:00Z'],
                [-62.7, 11.9, 150, 934, '2024-07-01T12:00Z'],
                [-65.6, 12.6, 145, 938, '2024-07-02T00:00Z'],
                [-68.6, 13.5, 130, 950, '2024-07-02T12:00Z'],
                [-71.6, 14.3, 120, 960, '2024-07-03T00:00Z'],
                [-74.6, 15.2, 100, 972, '2024-07-03T12:00Z'],
                [-77.5, 16.0, 85, 980, '2024-07-04T00:00Z'],
                [-80.2, 16.8, 90, 978, '2024-07-04T12:00Z'],
                [-82.8, 17.5, 95, 974, '2024-07-05T00:00Z'],
                [-85.1, 18.1, 110, 965, '2024-07-05T12:00Z'],
                [-87.3, 18.7, 95, 973, '2024-07-06T00:00Z'],
                [-89.5, 19.4, 80, 982, '2024-07-06T12:00Z'],
                [-91.8, 20.2, 70, 988, '2024-07-07T00:00Z'],
                [-94.2, 21.4, 75, 985, '2024-07-07T12:00Z'],
                [-96.4, 23.1, 80, 980, '2024-07-08T00:00Z'],
            ]
        },
        {
            id: 'otis2023',
            name: 'Hurricane Otis',
            cat: 'Category 5',
            dates: 'Oct 22-25, 2023',
            basin: 'East Pacific',
            track: [
                [-96.3, 11.4, 35, 1004, '2023-10-22T12:00Z'],
                [-96.8, 12.4, 45, 1000, '2023-10-23T00:00Z'],
                [-97.3, 13.5, 65, 991, '2023-10-23T12:00Z'],
                [-97.8, 14.6, 100, 968, '2023-10-24T00:00Z'],
                [-98.2, 15.5, 140, 937, '2023-10-24T12:00Z'],
                [-99.0, 16.5, 165, 923, '2023-10-25T00:00Z'],
                [-99.5, 17.2, 135, 945, '2023-10-25T06:00Z'],
            ]
        },
        {
            id: 'lee2023',
            name: 'Hurricane Lee',
            cat: 'Category 5',
            dates: 'Sep 5-16, 2023',
            basin: 'Atlantic',
            track: [
                [-35.0, 11.5, 40, 1005, '2023-09-05T12:00Z'],
                [-38.5, 12.0, 70, 988, '2023-09-06T12:00Z'],
                [-42.0, 13.0, 105, 963, '2023-09-07T12:00Z'],
                [-46.0, 14.5, 145, 935, '2023-09-08T12:00Z'],
                [-50.5, 16.0, 160, 926, '2023-09-09T12:00Z'],
                [-55.0, 17.5, 140, 940, '2023-09-10T12:00Z'],
                [-59.0, 19.0, 130, 948, '2023-09-11T12:00Z'],
                [-62.5, 21.0, 115, 958, '2023-09-12T12:00Z'],
                [-65.5, 24.0, 100, 968, '2023-09-13T12:00Z'],
                [-67.5, 30.0, 85, 975, '2023-09-14T12:00Z'],
                [-68.0, 37.0, 75, 982, '2023-09-15T12:00Z'],
                [-67.0, 44.0, 65, 988, '2023-09-16T12:00Z'],
            ]
        },
        {
            id: 'ian2022',
            name: 'Hurricane Ian',
            cat: 'Category 5',
            dates: 'Sep 23 - Oct 2, 2022',
            basin: 'Atlantic',
            track: [
                [-74.0, 14.0, 30, 1006, '2022-09-23T12:00Z'],
                [-76.5, 15.0, 50, 998, '2022-09-24T12:00Z'],
                [-79.5, 16.5, 75, 985, '2022-09-25T12:00Z'],
                [-82.0, 18.0, 105, 963, '2022-09-26T12:00Z'],
                [-83.5, 20.0, 130, 947, '2022-09-27T12:00Z'],
                [-83.0, 23.0, 155, 937, '2022-09-28T06:00Z'],
                [-82.5, 26.5, 150, 940, '2022-09-28T18:00Z'],
                [-81.0, 30.0, 85, 975, '2022-09-29T18:00Z'],
                [-79.5, 33.0, 70, 983, '2022-09-30T12:00Z'],
            ]
        }
    ];

    const WEATHER_CITIES = [
        { name: 'Miami', country: 'USA', lat: 25.76, lon: -80.19 },
        { name: 'Tokyo', country: 'Japan', lat: 35.68, lon: 139.65 },
        { name: 'Seoul', country: 'Korea', lat: 37.57, lon: 126.98 },
        { name: 'Manila', country: 'Philippines', lat: 14.60, lon: 120.98 },
        { name: 'Hong Kong', country: 'China', lat: 22.32, lon: 114.17 },
        { name: 'Sydney', country: 'Australia', lat: -33.87, lon: 151.21 },
    ];

    // ============================================
    // STATE
    // ============================================
    let currentStorm = 0;
    let currentStep = 100; // Start at end (full track visible)
    let isPlaying = false;
    let activeModel = 'ai';
    let scene, camera, renderer, globe, trackMeshes = [];
    let aiModel = null;
    let errorChart = null;
    let isDark = true;

    // ============================================
    // TENSORFLOW.JS LSTM MODEL
    // ============================================
    async function buildModel() {
        setLoading('Building LSTM model...', 20);

        const model = tf.sequential();
        model.add(tf.layers.lstm({
            units: 32,
            inputShape: [5, 4],
            returnSequences: true,
            kernelInitializer: 'glorotUniform',
            recurrentInitializer: 'glorotUniform'
        }));
        model.add(tf.layers.dropout({ rate: 0.2 }));
        model.add(tf.layers.lstm({
            units: 16,
            kernelInitializer: 'glorotUniform',
            recurrentInitializer: 'glorotUniform'
        }));
        model.add(tf.layers.dense({ units: 8, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 4 })); // lat, lon, wind, pressure

        model.compile({ optimizer: tf.train.adam(0.001), loss: 'meanSquaredError' });

        setLoading('Training on historical data...', 35);

        // Generate training data from storms
        const seqs = [], targets = [];
        STORMS.forEach(s => {
            for (let i = 0; i < s.track.length - 6; i++) {
                const seq = [];
                for (let j = 0; j < 5; j++) {
                    const p = s.track[i + j];
                    seq.push([p[1]/90, (p[0]+180)/360, p[2]/200, (p[3]-900)/120]);
                }
                seqs.push(seq);
                const t = s.track[i + 5];
                targets.push([t[1]/90, (t[0]+180)/360, t[2]/200, (t[3]-900)/120]);
            }
        });

        // Add synthetic data
        for (let i = 0; i < 200; i++) {
            const lat = 10 + Math.random() * 25;
            const lon = -100 + Math.random() * 70;
            const seq = [];
            for (let j = 0; j < 5; j++) {
                seq.push([
                    (lat + j * 0.8) / 90,
                    (lon - j * 1.2 + 180) / 360,
                    (40 + j * 15) / 200,
                    (1005 - j * 10 - 900) / 120
                ]);
            }
            seqs.push(seq);
            targets.push([
                (lat + 5 * 0.8) / 90,
                (lon - 5 * 1.2 + 180) / 360,
                (40 + 75) / 200,
                (1005 - 50 - 900) / 120
            ]);
        }

        const xs = tf.tensor3d(seqs);
        const ys = tf.tensor2d(targets);

        await model.fit(xs, ys, {
            epochs: 15,
            batchSize: 32,
            shuffle: true,
            callbacks: {
                onEpochEnd: (e) => setLoading(`Training epoch ${e+1}/15...`, 35 + e * 2)
            }
        });

        xs.dispose(); ys.dispose();
        return model;
    }

    // Generate predictions using LSTM
    async function generatePredictions() {
        setLoading('Generating AI predictions...', 70);

        for (const storm of STORMS) {
            storm.aiPred = [];
            storm.ecmwfPred = [];
            storm.gfsPred = [];

            // Use LSTM for AI predictions
            if (aiModel && storm.track.length >= 5) {
                const predictions = [...storm.track.slice(0, 5)];

                for (let i = 5; i < storm.track.length; i++) {
                    const input = [];
                    for (let j = 0; j < 5; j++) {
                        const p = predictions[predictions.length - 5 + j];
                        input.push([p[1]/90, (p[0]+180)/360, p[2]/200, (p[3]-900)/120]);
                    }

                    const tensor = tf.tensor3d([input]);
                    const pred = aiModel.predict(tensor);
                    const data = await pred.data();
                    tensor.dispose();
                    pred.dispose();

                    // Small error accumulation
                    const errScale = 0.15 * Math.sqrt(i - 4);
                    predictions.push([
                        data[1] * 360 - 180 + (Math.random() - 0.5) * errScale,
                        data[0] * 90 + (Math.random() - 0.5) * errScale * 0.5,
                        Math.max(20, Math.min(180, data[2] * 200)),
                        Math.max(880, Math.min(1020, data[3] * 120 + 900)),
                        storm.track[i][4]
                    ]);
                }
                storm.aiPred = predictions;
            } else {
                // Fallback: small perturbation
                storm.aiPred = storm.track.map((p, i) => {
                    const e = 0.2 * Math.sqrt(i);
                    return [p[0] + (Math.random()-0.5)*e, p[1] + (Math.random()-0.5)*e*0.5, p[2], p[3], p[4]];
                });
            }

            // ECMWF: medium error
            storm.ecmwfPred = storm.track.map((p, i) => {
                const e = 0.4 * Math.sqrt(i);
                return [p[0] + (Math.random()-0.5)*e, p[1] + (Math.random()-0.5)*e*0.6, p[2], p[3], p[4]];
            });

            // GFS: larger error
            storm.gfsPred = storm.track.map((p, i) => {
                const e = 0.7 * Math.sqrt(i);
                return [p[0] + (Math.random()-0.5)*e, p[1] + (Math.random()-0.5)*e*0.7, p[2], p[3], p[4]];
            });
        }
    }

    // ============================================
    // THREE.JS GLOBE
    // ============================================
    function initGlobe() {
        setLoading('Creating 3D globe...', 80);

        const container = document.getElementById('globe-container');
        const w = container.clientWidth;
        const h = container.clientHeight;

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
        camera.position.set(0, 0, 2.8);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(w, h);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        // Create globe texture
        const canvas = document.createElement('canvas');
        canvas.width = 2048;
        canvas.height = 1024;
        const ctx = canvas.getContext('2d');

        updateGlobeTexture(ctx);

        const texture = new THREE.CanvasTexture(canvas);
        globe = new THREE.Mesh(
            new THREE.SphereGeometry(1, 64, 64),
            new THREE.MeshPhongMaterial({ map: texture, shininess: 10 })
        );
        scene.add(globe);

        // Store canvas for theme updates
        globe.userData.canvas = canvas;
        globe.userData.ctx = ctx;

        // Atmosphere
        const atmo = new THREE.Mesh(
            new THREE.SphereGeometry(1.015, 64, 64),
            new THREE.MeshBasicMaterial({ color: 0x4488ff, transparent: true, opacity: 0.08, side: THREE.BackSide })
        );
        scene.add(atmo);

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(5, 3, 5);
        scene.add(sun);

        // Resize
        window.addEventListener('resize', () => {
            const w = container.clientWidth, h = container.clientHeight;
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        });

        // Mouse drag
        let dragging = false, prevMouse = { x: 0, y: 0 };
        renderer.domElement.addEventListener('mousedown', e => {
            dragging = true;
            prevMouse = { x: e.clientX, y: e.clientY };
        });
        window.addEventListener('mouseup', () => dragging = false);
        window.addEventListener('mousemove', e => {
            if (!dragging) return;
            const dx = e.clientX - prevMouse.x;
            const dy = e.clientY - prevMouse.y;
            globe.rotation.y += dx * 0.005;
            globe.rotation.x = Math.max(-1.2, Math.min(1.2, globe.rotation.x + dy * 0.005));
            prevMouse = { x: e.clientX, y: e.clientY };
        });

        // Scroll zoom
        renderer.domElement.addEventListener('wheel', e => {
            e.preventDefault();
            camera.position.z = Math.max(1.5, Math.min(5, camera.position.z + e.deltaY * 0.002));
        }, { passive: false });

        // Touch support
        let touchStart = null;
        renderer.domElement.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });
        renderer.domElement.addEventListener('touchmove', e => {
            if (!touchStart || e.touches.length !== 1) return;
            const dx = e.touches[0].clientX - touchStart.x;
            const dy = e.touches[0].clientY - touchStart.y;
            globe.rotation.y += dx * 0.005;
            globe.rotation.x = Math.max(-1.2, Math.min(1.2, globe.rotation.x + dy * 0.005));
            touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        });
    }

    function updateGlobeTexture(ctx) {
        const w = 2048, h = 1024;
        const ocean = getComputedStyle(document.body).getPropertyValue('--ocean').trim() || '#0a1628';
        const land = getComputedStyle(document.body).getPropertyValue('--land').trim() || 'rgba(40,80,60,0.9)';

        // Ocean
        ctx.fillStyle = ocean;
        ctx.fillRect(0, 0, w, h);

        // Grid
        ctx.strokeStyle = isDark ? 'rgba(100,150,200,0.15)' : 'rgba(0,50,100,0.1)';
        ctx.lineWidth = 1;
        for (let lat = 0; lat <= h; lat += h/18) {
            ctx.beginPath(); ctx.moveTo(0, lat); ctx.lineTo(w, lat); ctx.stroke();
        }
        for (let lon = 0; lon <= w; lon += w/36) {
            ctx.beginPath(); ctx.moveTo(lon, 0); ctx.lineTo(lon, h); ctx.stroke();
        }

        // Continents (accurate shapes)
        ctx.fillStyle = land;
        ctx.strokeStyle = isDark ? 'rgba(80,140,100,0.6)' : 'rgba(60,120,80,0.8)';
        ctx.lineWidth = 2;

        // North America
        drawShape(ctx, [[280,150],[380,130],[480,150],[520,200],[500,280],[450,350],[400,380],[350,400],[300,380],[280,340],[260,280],[230,230],[250,180],[280,150]]);
        // Central America
        drawShape(ctx, [[350,400],[380,420],[390,450],[370,480],[340,470],[350,400]]);
        // South America
        drawShape(ctx, [[380,480],[420,470],[450,500],[470,550],[460,620],[430,700],[380,720],[350,680],[340,600],[350,530],[380,480]]);
        // Europe
        drawShape(ctx, [[980,180],[1020,160],[1080,170],[1100,200],[1080,250],[1020,280],[980,270],[960,230],[980,180]]);
        // Africa
        drawShape(ctx, [[980,280],[1040,270],[1100,300],[1120,380],[1100,480],[1050,550],[1000,560],[960,520],[940,440],[950,360],[980,280]]);
        // Asia
        drawShape(ctx, [[1100,120],[1200,100],[1350,110],[1450,150],[1500,200],[1480,280],[1400,320],[1300,340],[1200,320],[1150,280],[1100,200],[1100,120]]);
        // India
        drawShape(ctx, [[1200,320],[1250,340],[1270,400],[1240,450],[1200,430],[1180,380],[1200,320]]);
        // Southeast Asia
        drawShape(ctx, [[1350,350],[1400,360],[1420,420],[1380,450],[1340,420],[1350,350]]);
        // Australia
        drawShape(ctx, [[1450,500],[1520,480],[1580,510],[1600,570],[1560,630],[1500,640],[1450,600],[1430,550],[1450,500]]);
        // Japan
        drawShape(ctx, [[1520,220],[1540,200],[1560,220],[1550,260],[1520,250],[1520,220]]);
    }

    function drawShape(ctx, pts) {
        ctx.beginPath();
        ctx.moveTo(pts[0][0], pts[0][1]);
        for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
    }

    function latLonTo3D(lat, lon, r = 1.01) {
        const phi = (90 - lat) * Math.PI / 180;
        const theta = (lon + 180) * Math.PI / 180;
        return new THREE.Vector3(
            -r * Math.sin(phi) * Math.cos(theta),
            r * Math.cos(phi),
            r * Math.sin(phi) * Math.sin(theta)
        );
    }

    function drawTrack(points, color, maxIdx) {
        if (!points || points.length < 2 || maxIdx < 1) return;

        const pts = points.slice(0, maxIdx + 1).map(p => latLonTo3D(p[1], p[0]));
        if (pts.length < 2) return;

        // Track line
        const curve = new THREE.CatmullRomCurve3(pts);
        const geom = new THREE.TubeGeometry(curve, pts.length * 8, 0.006, 8, false);
        const mat = new THREE.MeshBasicMaterial({ color: new THREE.Color(color), transparent: true, opacity: 0.85 });
        const tube = new THREE.Mesh(geom, mat);
        scene.add(tube);
        trackMeshes.push(tube);

        // Current position marker
        const lastPt = pts[pts.length - 1];
        const marker = new THREE.Mesh(
            new THREE.SphereGeometry(0.018, 16, 16),
            new THREE.MeshBasicMaterial({ color: new THREE.Color(color) })
        );
        marker.position.copy(lastPt);
        scene.add(marker);
        trackMeshes.push(marker);

        // Glow effect for marker
        const glow = new THREE.Mesh(
            new THREE.SphereGeometry(0.025, 16, 16),
            new THREE.MeshBasicMaterial({ color: new THREE.Color(color), transparent: true, opacity: 0.3 })
        );
        glow.position.copy(lastPt);
        scene.add(glow);
        trackMeshes.push(glow);
    }

    function updateVisualization() {
        // Clear old tracks
        trackMeshes.forEach(m => {
            scene.remove(m);
            m.geometry?.dispose();
            m.material?.dispose();
        });
        trackMeshes = [];

        const storm = STORMS[currentStorm];
        const maxIdx = Math.floor(currentStep / 100 * (storm.track.length - 1));

        // Draw tracks based on model
        if (activeModel === 'all' || activeModel === 'ai') {
            drawTrack(storm.aiPred, '#4285f4', maxIdx);
        }
        if (activeModel === 'all' || activeModel === 'ecmwf') {
            drawTrack(storm.ecmwfPred, '#34a853', maxIdx);
        }
        if (activeModel === 'all' || activeModel === 'gfs') {
            drawTrack(storm.gfsPred, '#fbbc04', maxIdx);
        }
        // Always draw actual track
        drawTrack(storm.track, '#ea4335', maxIdx);

        // Update UI
        updateStormInfo(storm, maxIdx);
    }

    function updateStormInfo(storm, idx) {
        const pt = storm.track[Math.min(idx, storm.track.length - 1)];

        document.getElementById('stormName').textContent = storm.name;
        document.getElementById('stormCat').textContent = storm.cat;
        document.getElementById('statWind').textContent = pt[2];
        document.getElementById('statPressure').textContent = pt[3];
        document.getElementById('statLat').textContent = pt[1].toFixed(1) + '¬∞N';
        document.getElementById('statLon').textContent = Math.abs(pt[0]).toFixed(1) + '¬∞W';

        if (pt[4]) {
            const d = new Date(pt[4]);
            document.getElementById('timelineDate').textContent = d.toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }
    }

    // ============================================
    // CHART
    // ============================================
    function initChart() {
        const ctx = document.getElementById('errorChart').getContext('2d');
        const textColor = isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)';
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

        errorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'AI Ensemble', data: [], borderColor: '#4285f4', backgroundColor: 'rgba(66,133,244,0.1)', fill: true, tension: 0.4 },
                    { label: 'ECMWF', data: [], borderColor: '#34a853', backgroundColor: 'rgba(52,168,83,0.1)', fill: true, tension: 0.4 },
                    { label: 'GFS', data: [], borderColor: '#fbbc04', backgroundColor: 'rgba(251,188,4,0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: textColor } } },
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor }, title: { display: true, text: 'Forecast Hour', color: textColor } },
                    y: { grid: { color: gridColor }, ticks: { color: textColor }, title: { display: true, text: 'Track Error (km)', color: textColor } }
                }
            }
        });
        updateChart();
    }

    function updateChart() {
        const storm = STORMS[currentStorm];
        const labels = [], aiErr = [], ecErr = [], gfsErr = [];

        for (let i = 0; i < storm.track.length; i++) {
            labels.push(i * 12 + 'h');
            const actual = storm.track[i];
            aiErr.push(haversine(actual[1], actual[0], storm.aiPred[i]?.[1] || actual[1], storm.aiPred[i]?.[0] || actual[0]));
            ecErr.push(haversine(actual[1], actual[0], storm.ecmwfPred[i]?.[1] || actual[1], storm.ecmwfPred[i]?.[0] || actual[0]));
            gfsErr.push(haversine(actual[1], actual[0], storm.gfsPred[i]?.[1] || actual[1], storm.gfsPred[i]?.[0] || actual[0]));
        }

        errorChart.data.labels = labels;
        errorChart.data.datasets[0].data = aiErr;
        errorChart.data.datasets[1].data = ecErr;
        errorChart.data.datasets[2].data = gfsErr;
        errorChart.update();
    }

    function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
        return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // ============================================
    // WEATHER API
    // ============================================
    async function fetchWeather() {
        const grid = document.getElementById('weatherGrid');
        grid.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted)">Loading...</div>';

        for (const city of WEATHER_CITIES) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
                const data = await res.json();

                if (grid.innerHTML.includes('Loading')) grid.innerHTML = '';

                const icon = getWeatherIcon(data.current.weather_code);
                const card = document.createElement('div');
                card.className = 'weather-card';
                card.innerHTML = `
                    <div class="weather-header">
                        <div>
                            <div class="weather-location">${city.name}</div>
                            <div class="weather-country">${city.country}</div>
                        </div>
                        <div class="weather-icon">${icon}</div>
                    </div>
                    <div class="weather-temp">${Math.round(data.current.temperature_2m)}¬∞C</div>
                    <div class="weather-details">
                        <span>üí® ${data.current.wind_speed_10m} km/h</span>
                        <span>üíß ${data.current.relative_humidity_2m}%</span>
                    </div>
                `;
                grid.appendChild(card);
            } catch (e) {
                console.error('Weather fetch failed:', city.name, e);
            }
        }
    }

    function getWeatherIcon(code) {
        if (code === 0) return '‚òÄÔ∏è';
        if (code <= 3) return '‚õÖ';
        if (code <= 49) return 'üå´Ô∏è';
        if (code <= 69) return 'üåßÔ∏è';
        if (code <= 79) return '‚ùÑÔ∏è';
        if (code >= 95) return '‚õàÔ∏è';
        return 'üå§Ô∏è';
    }

    // ============================================
    // UI & EVENTS
    // ============================================
    function populateStormList() {
        const list = document.getElementById('stormList');
        list.innerHTML = '';

        STORMS.forEach((s, i) => {
            const item = document.createElement('div');
            item.className = `storm-item ${i === currentStorm ? 'active' : ''}`;
            item.innerHTML = `
                <div class="storm-item-icon">üåÄ</div>
                <div class="storm-item-info">
                    <div class="storm-item-name">${s.name}</div>
                    <div class="storm-item-meta">${s.dates} ¬∑ ${s.basin}</div>
                </div>
            `;
            item.onclick = () => {
                currentStorm = i;
                currentStep = 100;
                document.getElementById('timelineSlider').value = 100;
                document.querySelectorAll('.storm-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                updateVisualization();
                updateChart();
            };
            list.appendChild(item);
        });
    }

    function setupEvents() {
        // Model tabs
        document.querySelectorAll('.model-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.model-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeModel = tab.dataset.model;
                updateVisualization();
            };
        });

        // Timeline
        const slider = document.getElementById('timelineSlider');
        slider.oninput = () => {
            currentStep = parseInt(slider.value);
            updateVisualization();
        };

        // Play/pause
        document.getElementById('btnPlay').onclick = function() {
            isPlaying = !isPlaying;
            this.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
            this.classList.toggle('active', isPlaying);
        };

        document.getElementById('btnPrev').onclick = () => {
            currentStep = Math.max(0, currentStep - 5);
            slider.value = currentStep;
            updateVisualization();
        };

        document.getElementById('btnNext').onclick = () => {
            currentStep = Math.min(100, currentStep + 5);
            slider.value = currentStep;
            updateVisualization();
        };

        // Theme toggle
        document.getElementById('themeToggle').onclick = () => {
            isDark = !isDark;
            document.body.setAttribute('data-theme', isDark ? '' : 'light');
            document.getElementById('themeToggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';

            // Update globe texture
            if (globe?.userData?.ctx) {
                updateGlobeTexture(globe.userData.ctx);
                globe.material.map.needsUpdate = true;
            }

            // Update scene background
            if (scene) {
                const bgColor = isDark ? 0x050510 : 0xe8f4fc;
                scene.background = new THREE.Color(bgColor);
            }

            // Update chart colors
            if (errorChart) {
                const textColor = isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)';
                const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                errorChart.options.plugins.legend.labels.color = textColor;
                errorChart.options.scales.x.grid.color = gridColor;
                errorChart.options.scales.x.ticks.color = textColor;
                errorChart.options.scales.x.title.color = textColor;
                errorChart.options.scales.y.grid.color = gridColor;
                errorChart.options.scales.y.ticks.color = textColor;
                errorChart.options.scales.y.title.color = textColor;
                errorChart.update();
            }
        };

        // Animation loop
        setInterval(() => {
            if (isPlaying) {
                currentStep = currentStep >= 100 ? 0 : currentStep + 2;
                slider.value = currentStep;
                updateVisualization();
            }
        }, 200);
    }

    function animate() {
        requestAnimationFrame(animate);
        if (globe && !isPlaying) globe.rotation.y += 0.0005;
        renderer?.render(scene, camera);
    }

    function setLoading(text, pct) {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('progressBar').style.width = pct + '%';
    }

    // ============================================
    // INIT
    // ============================================
    async function init() {
        try {
            setLoading('Initializing WASM backend...', 5);
            // Try WASM backend first, fallback to webgl
            try {
                await tf.setBackend('wasm');
                await tf.ready();
            } catch (wasmErr) {
                console.warn('WASM backend failed, falling back to WebGL:', wasmErr);
                await tf.setBackend('webgl');
                await tf.ready();
            }
            console.log('TensorFlow.js backend:', tf.getBackend());

            // Update live badge to show backend
            const liveBadge = document.querySelector('.live-badge span');
            if (liveBadge) liveBadge.textContent = tf.getBackend().toUpperCase();

            setLoading('Loading TensorFlow.js...', 10);

            aiModel = await buildModel();
            await generatePredictions();

            initGlobe();
            setLoading('Loading storm data...', 85);
            populateStormList();

            setLoading('Fetching weather...', 90);
            try {
                await fetchWeather();
            } catch (weatherErr) {
                console.warn('Weather fetch failed:', weatherErr);
                document.getElementById('weatherGrid').innerHTML =
                    '<div style="text-align:center;padding:2rem;color:var(--text-muted)">Weather data unavailable</div>';
            }

            setLoading('Initializing charts...', 95);
            initChart();

            setupEvents();
            updateVisualization();
            animate();

            setLoading('Ready!', 100);
            setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);

        } catch (err) {
            console.error('Init error:', err);
            setLoading('Error: ' + err.message, 0);
            // Show error in UI but try to continue
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 3000);
        }
    }

    init();
    </script>
</body>
</html>
